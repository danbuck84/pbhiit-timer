import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, RotateCcw, Plus, Minus, Volume2, VolumeX, Settings, Bike, Zap, Calendar, Sun, Moon, Mic, Bell, Save, Trash2, History, Trophy, Flame } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, User, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, Timestamp, deleteDoc, doc, setDoc } from 'firebase/firestore';

// --- Firebase Setup ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Audio Engine ---
const playTone = (freq = 440, type = 'sine', duration = 0.1) => {
    const AudioContext = window.AudioContext || (window as any).webkitAudioContext;
    if (!AudioContext) return;
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type as any;
    osc.frequency.setValueAtTime(freq, ctx.currentTime);
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + duration);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + duration);
};

const speak = (text: string) => {
    if (!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel(); // Cancel previous
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'pt-BR';
    utterance.rate = 1.2;
    window.speechSynthesis.speak(utterance);
};

// --- Types ---
type PhaseType = 'warmup' | 'work' | 'rest' | 'cooldown';
type AudioMode = 'beep' | 'voice' | 'mute';

interface Interval {
    type: PhaseType;
    duration: number;
    name: string;
}

interface Program {
    id: string;
    name: string;
    intervals: Interval[];
    totalTime: number;
    isCustom?: boolean;
}

interface WorkoutLog {
    id: string;
    programName: string;
    completedAt: any; // Timestamp
    duration: number;
}

// --- Presets ---
const PRESETS: Program[] = [
    {
        id: 'tabata',
        name: 'Tabata Clássico',
        totalTime: 240,
        intervals: [
            { type: 'warmup', duration: 10, name: 'Aquecer' },
            ...Array(8).fill(null).flatMap(() => [
                { type: 'work', duration: 20, name: 'TIRO MÁXIMO' },
                { type: 'rest', duration: 10, name: 'Descanso' }
            ]),
            { type: 'cooldown', duration: 30, name: 'Resfriar' }
        ]
    },
    {
        id: 'sprint_intervals',
        name: 'Sprints de 30s',
        totalTime: 600,
        intervals: [
            { type: 'warmup', duration: 60, name: 'Pedal Leve' },
            ...Array(5).fill(null).flatMap(() => [
                { type: 'work', duration: 30, name: 'SPRINT' },
                { type: 'rest', duration: 60, name: 'Recuperar' }
            ]),
            { type: 'cooldown', duration: 50, name: 'Relaxar' }
        ]
    }
];

export default function App() {
    // --- Global State ---
    const [user, setUser] = useState<User | null>(null);
    const [theme, setTheme] = useState<'dark' | 'light'>('dark');
    const [audioMode, setAudioMode] = useState<AudioMode>('beep');

    // --- App State ---
    const [view, setView] = useState<'home' | 'builder' | 'active' | 'history'>('home');
    const [activeProgram, setActiveProgram] = useState<Program | null>(null);
    const [customPrograms, setCustomPrograms] = useState<Program[]>([]);
    const [history, setHistory] = useState<WorkoutLog[]>([]);
    const [streak, setStreak] = useState(0);

    // --- Active Workout State ---
    const [isRunning, setIsRunning] = useState(false);
    const [currentIntervalIndex, setCurrentIntervalIndex] = useState(0);
    const [timeLeft, setTimeLeft] = useState(0);
    const timerRef = useRef<number | null>(null);

    // --- Builder State ---
    const [buildName, setBuildName] = useState('Meu Treino');
    const [buildWork, setBuildWork] = useState(30);
    const [buildRest, setBuildRest] = useState(30);
    const [buildRounds, setBuildRounds] = useState(10);
    const [buildWarmup, setBuildWarmup] = useState(60);

    // --- Auth & Data Sync ---
    useEffect(() => {
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();
        return onAuthStateChanged(auth, setUser);
    }, []);

    useEffect(() => {
        if (!user) return;

        // 1. Listen to Custom Programs
        const progsQuery = query(collection(db, 'artifacts', appId, 'users', user.uid, 'programs'));
        const unsubProgs = onSnapshot(progsQuery, (snap) => {
            const loaded: Program[] = snap.docs.map(d => ({ id: d.id, ...d.data() } as Program));
            setCustomPrograms(loaded);
        }, (err) => console.error(err));

        // 2. Listen to History
        const histQuery = query(collection(db, 'artifacts', appId, 'users', user.uid, 'history'), orderBy('completedAt', 'desc'));
        const unsubHist = onSnapshot(histQuery, (snap) => {
            const logs = snap.docs.map(d => ({ id: d.id, ...d.data() } as WorkoutLog));
            setHistory(logs);
            calculateStreak(logs);
        }, (err) => console.error(err));

        return () => { unsubProgs(); unsubHist(); };
    }, [user]);

    // --- Helpers ---
    const calculateStreak = (logs: WorkoutLog[]) => {
        if (logs.length === 0) { setStreak(0); return; }

        // Simple daily streak logic
        const today = new Date().setHours(0, 0, 0, 0);
        const uniqueDays = new Set(logs.map(l => {
            if (!l.completedAt) return 0;
            return new Date(l.completedAt.seconds * 1000).setHours(0, 0, 0, 0);
        }));

        let currentStreak = 0;
        let checkDay = today;

        // Check if we trained today, if not, check yesterday to start counting
        if (!uniqueDays.has(today)) {
            checkDay -= 86400000;
            if (!uniqueDays.has(checkDay)) {
                setStreak(0);
                return;
            }
        }

        while (uniqueDays.has(checkDay)) {
            currentStreak++;
            checkDay -= 86400000;
        }
        setStreak(currentStreak);
    };

    const saveCompletedWorkout = async () => {
        if (!user || !activeProgram) return;
        try {
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'history'), {
                programName: activeProgram.name,
                duration: activeProgram.totalTime,
                completedAt: Timestamp.now()
            });
            if (audioMode === 'voice') speak("Treino concluído. Parabéns!");
            else if (audioMode === 'beep') playTone(880, 'triangle', 1);
        } catch (e) { console.error(e); }
    };

    const saveCustom = async () => {
        if (!user) return;
        const intervals: Interval[] = [];
        if (buildWarmup > 0) intervals.push({ type: 'warmup', duration: buildWarmup, name: 'Aquecimento' });
        for (let i = 0; i < buildRounds; i++) {
            intervals.push({ type: 'work', duration: buildWork, name: `Round ${i + 1}` });
            if (buildRest > 0) intervals.push({ type: 'rest', duration: buildRest, name: 'Descanso' });
        }
        intervals.push({ type: 'cooldown', duration: 60, name: 'Resfriamento' });

        const newProg: Program = {
            id: 'temp', // Firestore will assign ID
            name: buildName,
            intervals,
            totalTime: intervals.reduce((a, b) => a + b.duration, 0),
            isCustom: true
        };

        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'programs'), newProg);
        setView('home');
    };

    const deleteCustom = async (id: string) => {
        if (!user) return;
        await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'programs', id));
    };

    // --- Timer Engine ---
    const startWorkout = (program: Program) => {
        setActiveProgram(program);
        setCurrentIntervalIndex(0);
        setTimeLeft(program.intervals[0].duration);
        setIsRunning(false);
        setView('active');
    };

    useEffect(() => {
        if (view !== 'active' || !isRunning || !activeProgram) {
            if (timerRef.current) clearInterval(timerRef.current);
            return;
        }

        timerRef.current = window.setInterval(() => {
            setTimeLeft((prev) => {
                // Audio Cues
                if (prev === 4 && audioMode === 'voice') speak("Prepare-se");
                if (prev <= 3 && prev > 0) {
                    if (audioMode === 'beep') playTone(440, 'sine', 0.1);
                    // if voice, we might just let "prepare-se" hang or count down
                }

                if (prev <= 0) {
                    // Switch Interval
                    const nextIdx = currentIntervalIndex + 1;
                    if (nextIdx < activeProgram.intervals.length) {
                        const nextInt = activeProgram.intervals[nextIdx];
                        setCurrentIntervalIndex(nextIdx);

                        // Announce next phase
                        if (audioMode === 'voice') speak(nextInt.name);
                        else if (audioMode === 'beep') playTone(880, 'square', 0.3);

                        return nextInt.duration;
                    } else {
                        // Finish
                        setIsRunning(false);
                        saveCompletedWorkout();
                        setView('home');
                        return 0;
                    }
                }
                return prev - 1;
            });
        }, 1000);

        return () => { if (timerRef.current) clearInterval(timerRef.current); };
    }, [isRunning, activeProgram, currentIntervalIndex, view, audioMode]);

    // --- UI Components ---
    const formatTime = (s: number) => `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;

    const themeClasses = theme === 'dark'
        ? 'bg-slate-900 text-white'
        : 'bg-slate-100 text-slate-900';

    const cardClasses = theme === 'dark'
        ? 'bg-slate-800 border-slate-700'
        : 'bg-white border-slate-200 shadow-sm';

    // --- Render: Home ---
    if (view === 'home') {
        return (
            <div className={`min-h-screen ${themeClasses} transition-colors duration-300 font-sans p-4 pb-20`}>
                {/* Header */}
                <div className="flex justify-between items-center mb-8 pt-4">
                    <div className="flex items-center gap-2">
                        <div className={`p-2 rounded-lg ${theme === 'dark' ? 'bg-orange-600' : 'bg-orange-500'}`}>
                            <Bike className="text-white" size={24} />
                        </div>
                        <h1 className="text-2xl font-black tracking-tight italic">PB <span className="text-orange-500">HIIT</span></h1>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={() => setTheme(t => t === 'dark' ? 'light' : 'dark')} className={`p-2 rounded-full ${cardClasses}`}>
                            {theme === 'dark' ? <Sun size={20} /> : <Moon size={20} />}
                        </button>
                        <button onClick={() => setAudioMode(m => m === 'beep' ? 'voice' : (m === 'voice' ? 'mute' : 'beep'))} className={`p-2 rounded-full ${cardClasses}`}>
                            {audioMode === 'beep' ? <Bell size={20} /> : (audioMode === 'voice' ? <Mic size={20} /> : <VolumeX size={20} />)}
                        </button>
                    </div>
                </div>

                {/* Streak Banner */}
                <div className="mb-6 bg-gradient-to-r from-orange-500 to-red-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                    <div className="relative z-10">
                        <p className="text-orange-100 text-sm font-medium uppercase tracking-wider mb-1">Sequência Atual</p>
                        <div className="flex items-baseline gap-2">
                            <span className="text-5xl font-black">{streak}</span>
                            <span className="text-xl font-medium opacity-90">dias</span>
                        </div>
                        <div className="mt-2 flex items-center gap-2 text-sm opacity-90">
                            <Flame size={16} fill="currentColor" />
                            {streak > 0 ? 'Mantenha o ritmo!' : 'Comece hoje!'}
                        </div>
                    </div>
                    <Trophy className="absolute -right-4 -bottom-4 text-white opacity-20" size={120} />
                </div>

                {/* Workouts List */}
                <div className="space-y-4">
                    <h2 className={`text-lg font-bold flex items-center gap-2 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                        <Zap size={18} /> Treinos Rápidos
                    </h2>
                    {[...PRESETS, ...customPrograms].map(p => (
                        <div key={p.id} className={`w-full p-4 rounded-xl border flex items-center justify-between group cursor-pointer hover:border-orange-500 transition-all ${cardClasses}`} onClick={() => startWorkout(p)}>
                            <div>
                                <h3 className="font-bold text-lg">{p.name}</h3>
                                <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                    {Math.floor(p.totalTime / 60)} min • {p.intervals.length} etapas
                                </p>
                            </div>
                            <div className="flex items-center gap-3">
                                {p.isCustom && (
                                    <button onClick={(e) => { e.stopPropagation(); deleteCustom(p.id); }} className="p-2 text-red-500 hover:bg-red-500/10 rounded-full">
                                        <Trash2 size={18} />
                                    </button>
                                )}
                                <div className="w-10 h-10 rounded-full bg-orange-500/10 flex items-center justify-center text-orange-500 group-hover:bg-orange-500 group-hover:text-white transition-colors">
                                    <Play size={20} fill="currentColor" />
                                </div>
                            </div>
                        </div>
                    ))}

                    <button onClick={() => setView('builder')} className={`w-full p-4 rounded-xl border border-dashed flex items-center justify-center gap-2 transition-all opacity-70 hover:opacity-100 ${theme === 'dark' ? 'border-gray-700 hover:bg-gray-800' : 'border-gray-300 hover:bg-gray-50'}`}>
                        <Plus size={20} /> Criar Novo Treino
                    </button>
                </div>

                {/* Navigation Bar */}
                <div className={`fixed bottom-0 left-0 right-0 p-4 border-t flex justify-around ${theme === 'dark' ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                    <button className="flex flex-col items-center gap-1 text-orange-500">
                        <Bike size={24} />
                        <span className="text-xs font-bold">Treinar</span>
                    </button>
                    <button onClick={() => setView('history')} className={`flex flex-col items-center gap-1 ${theme === 'dark' ? 'text-gray-500 hover:text-white' : 'text-gray-400 hover:text-gray-900'}`}>
                        <History size={24} />
                        <span className="text-xs font-medium">Histórico</span>
                    </button>
                </div>
            </div>
        );
    }

    // --- Render: Builder ---
    if (view === 'builder') {
        return (
            <div className={`min-h-screen ${themeClasses} p-6 flex flex-col`}>
                <div className="flex items-center gap-4 mb-8">
                    <button onClick={() => setView('home')}><RotateCcw /></button>
                    <h2 className="text-2xl font-bold">Novo Treino</h2>
                </div>

                <div className="flex-1 space-y-6 max-w-md mx-auto w-full">
                    <div>
                        <label className="text-sm font-medium opacity-70 mb-2 block">Nome do Treino</label>
                        <input
                            type="text"
                            value={buildName}
                            onChange={(e) => setBuildName(e.target.value)}
                            className={`w-full p-4 rounded-xl text-lg font-bold outline-none ring-2 ring-transparent focus:ring-orange-500 ${theme === 'dark' ? 'bg-slate-800' : 'bg-slate-200'}`}
                        />
                    </div>

                    {[
                        { l: 'Aquecimento', v: buildWarmup, s: setBuildWarmup, d: 30 },
                        { l: 'Esforço (Work)', v: buildWork, s: setBuildWork, d: 5 },
                        { l: 'Descanso (Rest)', v: buildRest, s: setBuildRest, d: 5 },
                        { l: 'Rounds', v: buildRounds, s: setBuildRounds, d: 1 },
                    ].map((item, i) => (
                        <div key={i} className={`p-4 rounded-xl flex justify-between items-center ${cardClasses}`}>
                            <span className="font-medium">{item.l}</span>
                            <div className="flex items-center gap-3">
                                <button onClick={() => item.s(Math.max(0, item.v - item.d))} className="p-2 rounded-lg bg-gray-500/10 hover:bg-gray-500/20"><Minus size={18} /></button>
                                <span className="w-12 text-center font-bold text-xl">{item.v}</span>
                                <button onClick={() => item.s(item.v + item.d)} className="p-2 rounded-lg bg-orange-500 text-white hover:bg-orange-600"><Plus size={18} /></button>
                            </div>
                        </div>
                    ))}
                </div>

                <button onClick={saveCustom} className="mt-8 w-full py-4 bg-orange-600 rounded-xl font-bold text-white text-lg flex items-center justify-center gap-2 shadow-lg shadow-orange-900/20">
                    <Save size={20} /> SALVAR TREINO
                </button>
            </div>
        );
    }

    // --- Render: History ---
    if (view === 'history') {
        return (
            <div className={`min-h-screen ${themeClasses} p-6`}>
                <div className="flex items-center gap-4 mb-8">
                    <button onClick={() => setView('home')}><RotateCcw /></button>
                    <h2 className="text-2xl font-bold">Histórico</h2>
                </div>

                <div className="space-y-4">
                    {history.length === 0 ? (
                        <div className="text-center opacity-50 mt-20">
                            <Calendar size={48} className="mx-auto mb-4" />
                            <p>Nenhum treino completado ainda.</p>
                        </div>
                    ) : (
                        history.map(log => (
                            <div key={log.id} className={`p-4 rounded-xl border flex justify-between items-center ${cardClasses}`}>
                                <div>
                                    <h4 className="font-bold">{log.programName}</h4>
                                    <p className="text-xs opacity-60">
                                        {log.completedAt ? new Date(log.completedAt.seconds * 1000).toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' }) : 'Data desconhecida'}
                                    </p>
                                </div>
                                <div className="text-right">
                                    <span className="text-orange-500 font-bold">{Math.floor(log.duration / 60)} min</span>
                                </div>
                            </div>
                        ))
                    )}
                </div>
            </div>
        );
    }

    // --- Render: Active Workout ---
    if (!activeProgram) return null;
    const currentInterval = activeProgram.intervals[currentIntervalIndex];

    // Dynamic colors based on phase
    const getPhaseColor = (p: PhaseType) => {
        switch (p) {
            case 'work': return 'bg-red-600';
            case 'rest': return 'bg-emerald-600';
            case 'warmup': return 'bg-yellow-500';
            default: return 'bg-blue-600';
        }
    };

    return (
        <div className={`fixed inset-0 flex flex-col transition-colors duration-500 ${theme === 'dark' ? 'bg-slate-950' : 'bg-white'}`}>
            {/* Active Header */}
            <div className="p-6 flex justify-between items-center z-10">
                <button onClick={() => { setIsRunning(false); setView('home'); }} className={`p-2 rounded-full backdrop-blur-md ${theme === 'dark' ? 'bg-white/10 text-white' : 'bg-black/5 text-black'}`}>
                    <RotateCcw size={24} />
                </button>
                <div className={`font-bold uppercase tracking-widest ${theme === 'dark' ? 'text-white/50' : 'text-black/50'}`}>
                    {activeProgram.name}
                </div>
                <div className="w-10" />
            </div>

            {/* Main Content */}
            <div className="flex-1 flex flex-col items-center justify-center relative">
                {/* Giant Phase Background */}
                <div className={`absolute inset-0 opacity-20 transition-colors duration-500 ${getPhaseColor(currentInterval.type)}`} />

                <div className={`relative z-10 px-8 py-3 rounded-full font-black text-2xl uppercase tracking-[0.2em] mb-8 shadow-xl text-white ${getPhaseColor(currentInterval.type)}`}>
                    {currentInterval.name}
                </div>

                <div className={`text-[9rem] sm:text-[12rem] font-black leading-none tracking-tighter tabular-nums z-10 ${theme === 'dark' ? 'text-white' : 'text-slate-900'}`}>
                    {formatTime(timeLeft)}
                </div>

                {/* Next Up */}
                {currentIntervalIndex + 1 < activeProgram.intervals.length && (
                    <div className={`mt-12 text-center z-10 animate-pulse ${theme === 'dark' ? 'text-white/50' : 'text-black/50'}`}>
                        <p className="text-xs uppercase font-bold tracking-widest mb-1">Próximo</p>
                        <p className="font-bold text-xl">
                            {activeProgram.intervals[currentIntervalIndex + 1].name}
                        </p>
                    </div>
                )}
            </div>

            {/* Controls */}
            <div className="p-10 pb-16 flex justify-center z-10">
                <button
                    onClick={() => setIsRunning(!isRunning)}
                    className={`w-28 h-28 rounded-full flex items-center justify-center shadow-2xl transition-all active:scale-95 ${isRunning
                        ? (theme === 'dark' ? 'bg-slate-800 text-white border-2 border-slate-700' : 'bg-white text-slate-900 border-2 border-slate-200')
                        : 'bg-orange-600 text-white hover:bg-orange-500'
                        }`}
                >
                    {isRunning ? <Pause size={48} fill="currentColor" /> : <Play size={48} fill="currentColor" className="ml-2" />}
                </button>
            </div>

            {/* Progress Bar */}
            <div className="h-3 bg-gray-200 w-full fixed bottom-0 left-0">
                <div
                    className="h-full bg-orange-500 transition-all duration-1000 ease-linear"
                    style={{ width: `${((currentIntervalIndex) / (activeProgram.intervals.length || 1)) * 100}%` }}
                />
            </div>
        </div>
    );
}
